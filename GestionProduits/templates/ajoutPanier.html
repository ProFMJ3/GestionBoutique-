{% extends "acceuil.html" %}
{% block contenu %}


<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajouter au Panier</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container mt-4">

    <h1 class="text-center">Ajout d'articles au panier</h1>

    <!-- Sélection du client -->
    <div class="mb-3">
        <label for="client" class="form-label">Sélectionner un client :</label>
        <select id="client" class="form-select">
            <option value="">-- Sélectionnez un client --</option>
            {% for client in clients %}
                <option value="{{ client.id }}">{{ client.nomClient }} </option>
            {% endfor %}
        </select>
    </div>

    <!-- Sélection de l'article -->
    <div class="mb-3">
        <label for="article" class="form-label">Sélectionner un article :</label>
        <select id="article" class="form-select">
            <option value="">-- Sélectionnez un article --</option>
            {% for article in articles %}
                <option value="{{ article.id }}" data-stock="{{ article.stock }}" data-prix="{{ article.prixUnitaire }}">
                    {{ article.nom }} - {{ article.prixUnitaire }} FCFA
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Quantité -->
    <div class="mb-3">
        <label for="quantite" class="form-label">Quantité :</label>
        <input type="number" id="quantite" class="form-control" min="1" value="1">
    </div>

    <!-- Bouton Ajouter -->
    <button id="ajouterPanier" class="btn btn-primary">Ajouter au panier</button>

    <script>
        $(document).ready(function () {
            $("#ajouterPanier").click(function () {
                let article_id = $("#article").val();
                let client_id = $("#client").val();
                let quantite = $("#quantite").val();
                let stock_disponible = $("#article option:selected").data("stock");

                if (!client_id || !article_id || quantite < 1) {
                    alert("Veuillez sélectionner un client, un article et une quantité valide.");
                    return;
                }

                if (quantite > stock_disponible) {
                    alert("Stock insuffisant !");
                    return;
                }

                $.ajax({
                    url: "{% url 'ajoutPanier' %}",
                    type: "POST",
                    headers: { "X-CSRFToken": getCookie("csrftoken") },
                    data: JSON.stringify({
                        article_id: article_id,
                        client_id: client_id,
                        quantite: quantite
                    }),
                    contentType: "application/json",
                    success: function (response) {
                        alert(response.message);
                    },
                    error: function () {
                        alert("Erreur lors de l'ajout au panier.");
                    }
                });
            });

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                    let cookies = document.cookie.split(";");
                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = cookies[i].trim();
                        if (cookie.startsWith(name + "=")) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>

</body>
</html>

{% endblock %}
